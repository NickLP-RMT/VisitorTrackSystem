<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <!-- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ + ‡∏à‡∏≠‡∏°‡∏µ notch -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2c5282" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ - RMT Visitor Check-in</title>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --pad:16px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoi UI,Roboto,Helvetica,Arial,'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#091f82 0%,#ffffff 100%);
      min-height:100dvh;
      padding:clamp(12px,3vw,20px);
      color:#333; line-height:1.55;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      -webkit-tap-highlight-color: transparent;
    }
    input,select,button{font-size:16px} /* ‡∏Å‡∏±‡∏ô iOS auto-zoom */
    .header{
      background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
      width:100%;max-width:680px;margin:0 auto 14px;padding:14px 16px;
      border-radius:16px;text-align:center;box-shadow:0 6px 22px rgba(0,0,0,.08);
      animation:fadeInUp .5s ease-out;
    }
    .company-name{font-size:20px;font-weight:700;color:#2c5282;margin-bottom:4px;letter-spacing:.3px}
    .system-title{font-size:12px;color:#4a5568;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
    .container{
      width:100%;max-width:680px;margin:0 auto;background:rgba(255,255,255,.98);
      backdrop-filter:blur(8px);padding:20px;border-radius:16px;
      box-shadow:0 14px 32px rgba(0,0,0,.12);position:relative;overflow:hidden;
      animation:fadeInUp .5s ease-out; animation-delay:.06s;
    }
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#2c5282,#3182ce,#4299e1)}
    .main-title{ text-align:center;color:#2c5282;margin-bottom:18px;font-size:20px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px }
    .form-section{background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid #e2e8f0}
    .section-title{font-size:15px;font-weight:700;color:#2d3748;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .form-group{margin-bottom:12px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}
    label{display:block;margin-bottom:6px;font-weight:700;font-size:14px;color:#2d3748}
    .required{color:#e53e3e}
    input,select{
      width:100%;padding:12px 14px;border-radius:12px;border:2px solid #e2e8f0;
      transition:border-color .2s, box-shadow .2s; background:#fff;
      touch-action:manipulation;
    }
    input:focus,select:focus{outline:none;border-color:#3182ce;box-shadow:0 0 0 3px rgba(49,130,206,.12)}
    input:invalid{border-color:#fc8181}
    .row-inline{display:flex;align-items:center;gap:10px}
    .muted{font-size:12px;color:#4a5568}
    .total-pill{padding:6px 10px;border-radius:999px;background:#e6fffa;border:1px solid #81e6d9;color:#285e61;font-weight:800}
    .submit-button{
      width:100%;padding:14px 20px;font-size:16px;font-weight:800;
      background:linear-gradient(135deg,#2c5282 0%,#3182ce 100%);
      color:#fff;border:none;border-radius:12px;cursor:pointer;transition:transform .06s ease, box-shadow .2s ease;
      box-shadow:0 8px 18px rgba(44,82,130,.28); margin-top:8px; letter-spacing:.2px;
      touch-action:manipulation;
    }
    .submit-button:active{transform:translateY(1px)}
    .submit-button:disabled{background:#a0aec0;box-shadow:none}
    .btn-secondary{
      width:100%;padding:12px 16px;font-size:15px;font-weight:700;background:#edf2f7;color:#2d3748;
      border:none;border-radius:12px;cursor:pointer;transition:background .2s; margin-top:8px
    }
    .btn-secondary:active{transform:translateY(1px)}
    .back-button{
      position:fixed;top:calc(env(safe-area-inset-top) + 10px);left:calc(env(safe-area-inset-left) + 10px);
      background:rgba(255,255,255,.92);backdrop-filter:blur(8px);
      border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-size:14px;font-weight:700;
      color:#2c5282;transition:transform .06s ease, box-shadow .2s ease; box-shadow:0 6px 18px rgba(0,0,0,.12); z-index:1000
    }
    .back-button:active{transform:translateY(1px)}
    /* SweetAlert2 full-bleed & safe-area */
    .swal2-popup.qr-fullscreen{ padding:0 !important; background:#000 !important; border-radius:0 !important; }
    .swal2-html-container{ margin:0 !important; padding:0 !important; }
    .qr-stage{
      width:100vw; height:100dvh; max-width:100vw; max-height:100dvh;
      display:flex; justify-content:center; align-items:center; margin:0; padding:0;
      /* ‡∏Å‡∏±‡∏ô burn-in ‡∏ö‡∏≤‡∏á‡∏à‡∏≠ + ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
      background:#fff;
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-top:env(safe-area-inset-top);
      padding-bottom:env(safe-area-inset-bottom);
    }
    @media (max-width:768px){
      .header{border-radius:14px}
      .container{border-radius:14px}
      .form-row{grid-template-columns:1fr}
    }
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .loading{display:inline-block;width:18px;height:18px;border:2px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin 1s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <button class="back-button" onclick="history.back()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>

  <div class="header">
    <div class="company-name">RMT CORPORATION</div>
    <div class="system-title">Visitor Registration System</div>
  </div>

  <div class="container">
    <h2 class="main-title">üìã ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>

    <form id="visitorForm" autocomplete="off">
      <div class="form-section">
        <div class="section-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>

        <div class="form-group">
          <label for="fullName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
          <input type="text" id="fullName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô"
                 required minlength="2" maxlength="120" autocapitalize="words" />
        </div>

        <div class="form-group">
          <label for="company">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î <span class="required">*</span></label>
          <input type="text" id="company" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"
                 required minlength="2" maxlength="120" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="carPlate">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ <span class="required">*</span></label>
            <input type="text" id="carPlate" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏Å 1234 / ABC 1234"
                   inputmode="text" maxlength="12" required />
          </div>

          <div class="form-group">
            <label for="followers">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</label>
            <select id="followers">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option>
              <option value="3">3</option><option value="4">4</option><option value="5">5</option>
              <option value="6">6</option><option value="7">7</option><option value="8">8</option>
              <option value="9">9</option><option value="10">10</option>
            </select>
            <div class="row-inline muted" style="margin-top:6px">
              <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> <span id="totalPeople" class="total-pill">1 ‡∏Ñ‡∏ô</span>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°</div>

        <div class="form-row">
          <div class="form-group">
            <label for="purpose">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå <span class="required">*</span></label>
            <select id="purpose" required>
              <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              <option value="‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô</option>
              <option value="‡∏™‡πà‡∏á-‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á">‡∏™‡πà‡∏á-‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</option>
              <option value="‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</option>
              <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
            </select>
          </div>

          <div class="form-group" id="purposeOtherGroup" style="display:none">
            <label for="purposeOther">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ) <span class="required">*</span></label>
            <input type="text" id="purposeOther" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" maxlength="120" />
          </div>

          <div class="form-group">
            <label for="department">‡πÅ‡∏ú‡∏ô‡∏Å <span class="required">*</span></label>
            <select id="department" required>
              <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              <option value="PD">PD</option>
              <option value="PC">PC</option>
              <option value="‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
              <option value="‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠">‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠</option>
              <option value="‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
              <option value="‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
              <option value="IT">IT</option>
              <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="contactPerson">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö <span class="required">*</span></label>
          <input type="text" id="contactPerson" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö"
                 required minlength="2" maxlength="120" />
        </div>

        <div class="form-group" style="margin-top:6px">
          <label class="row-inline" style="font-weight:700">
            <input type="checkbox" id="pdpaConsent" style="width:auto;margin-right:10px" />
            ‡∏â‡∏±‡∏ô‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA)
            <span class="required" style="margin-left:6px">*</span>
          </label>
          <div class="muted" style="margin-top:6px">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
        </div>
      </div>

      <button type="submit" class="submit-button" id="submitBtn">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
      <button type="button" class="btn-secondary" id="resetBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
    </form>
  </div>

  <script>
    // ---------- Shortcuts ----------
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    function formatCarPlate(v){
      return (v||'').toUpperCase().replace(/\s+/g,' ').trim();
    }

    function calcTotal(){
      const f = parseInt($('#followers').value || '0', 10);
      $('#totalPeople').textContent = (1+f) + ' ‡∏Ñ‡∏ô';
    }

    function getFormData(){
      const pv = $('#purpose').value === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'
        ? ($('#purposeOther').value.trim() || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')
        : $('#purpose').value;

      return {
        fullName: $('#fullName').value.trim(),
        company: $('#company').value.trim(),
        carPlate: $('#carPlate').value.trim(),
        followers: $('#followers').value,
        purpose: pv,
        contactPerson: $('#contactPerson').value.trim(),
        department: $('#department').value,
        total: 1 + parseInt($('#followers').value || '0', 10),
        pdpa: $('#pdpaConsent').checked ? 'yes' : 'no',
        ts: new Date().toISOString()
      };
    }

    function setLoading(b){
      const btn = $('#submitBtn');
      if(b){ btn.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...'; btn.disabled=true; }
      else { btn.innerHTML = '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÉ‡∏´‡∏°‡πà'; btn.disabled=false; }
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î QR ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á)
    function measureViewport(){
      const vv = window.visualViewport;
      const w = vv ? vv.width : window.innerWidth;
      const h = vv ? vv.height : window.innerHeight;
      return { w, h };
    }
    function computeQRSize(){
      const {w, h} = measureViewport();
      // ‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î" ‡∏Ç‡∏≠‡∏á Swal ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 56px) + safe-area
      const safeBottom = (window.CSS && CSS.supports('padding: env(safe-area-inset-bottom)')) ? 24 : 0;
      return Math.min(w, h - (56 + safeBottom));
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      // touch feedback
      $$('button').forEach(b=>{
        b.addEventListener('touchstart',()=> b.style.transform='scale(0.985)');
        b.addEventListener('touchend',()=> b.style.transform='');
      });

      // car plate format live
      $('#carPlate').addEventListener('input', (e)=>{
        const pos = e.target.selectionStart;
        e.target.value = formatCarPlate(e.target.value);
        e.target.setSelectionRange(pos,pos);
      });

      // followers -> total
      $('#followers').addEventListener('change', calcTotal);
      calcTotal();

      // purpose other
      $('#purpose').addEventListener('change', ()=>{
        const show = $('#purpose').value === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
        $('#purposeOtherGroup').style.display = show ? '' : 'none';
        if(!show) $('#purposeOther').value = '';
      });

      // restore session
      const saved = sessionStorage.getItem('visitorFormData');
      if(saved){
        try{
          const d = JSON.parse(saved);
          if(d.fullName) $('#fullName').value = d.fullName;
          if(d.company) $('#company').value = d.company;
          if(d.carPlate) $('#carPlate').value = d.carPlate;
          if(d.followers!=null) $('#followers').value = String(d.followers);
          if(d.department) $('#department').value = d.department;
          if(d.purpose){
            $('#purpose').value = (['‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô','‡∏™‡πà‡∏á-‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô','‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'].includes(d.purpose)) ? d.purpose : '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
            if($('#purpose').value==='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'){
              $('#purposeOtherGroup').style.display='';
              $('#purposeOther').value = (['‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô','‡∏™‡πà‡∏á-‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô','‡∏≠‡∏∑‡πà‡∏ô ‡πÜ'].includes(d.purpose)?'':d.purpose);
            }
          }
          if(d.pdpa==='yes') $('#pdpaConsent').checked = true;
          calcTotal();
        }catch{}
      }
    });

    // Enter -> next
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && e.target.tagName==='INPUT'){
        e.preventDefault();
        const nodes = $$('#visitorForm input, #visitorForm select');
        const idx = nodes.indexOf(e.target);
        if(idx < nodes.length - 1) nodes[idx+1].focus();
      }
    });

    // reset
    $('#resetBtn').addEventListener('click', ()=>{
      $('#visitorForm').reset();
      $('#purposeOtherGroup').style.display='none';
      $('#totalPeople').textContent='1 ‡∏Ñ‡∏ô';
      sessionStorage.removeItem('visitorFormData');
    });

    // submit
    let submitting = false;
    $('#visitorForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(submitting) return;
      const d = getFormData();

      // minimal checks (required ‡∏Ç‡∏≠‡∏á HTML ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
      if($('#purpose').value==='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ' && !$('#purposeOther').value.trim()){
        return Swal.fire({icon:'warning',title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå',text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‚Äú‡∏≠‡∏∑‡πà‡∏ô ‡πÜ‚Äù'});
      }
      if(!$('#pdpaConsent').checked){
        return Swal.fire({icon:'info',title:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°',text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA) ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠'});
      }

      sessionStorage.setItem('visitorFormData', JSON.stringify(d));
      submitting = true; setLoading(true);

      setTimeout(()=>{
        try{
          const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(d));

          // build fullscreen container
          const wrap = document.createElement('div');
          wrap.innerHTML = `<div id="qr-full" class="qr-stage" role="img" aria-label="Visitor QR"></div>`;
          const stage = wrap.querySelector('#qr-full');

          // function to (re)render QR to current viewport
          const renderQR = ()=>{
            stage.innerHTML = '';
            const size = Math.max(120, computeQRSize());
            new QRCode(stage, {
              text: compressed, width: size, height: size,
              colorDark:"#000000", colorLight:"#ffffff", correctLevel: QRCode.CorrectLevel.H
            });
            const node = stage.querySelector('canvas, img');
            if(node){
              node.style.width='100vw'; node.style.height='auto'; node.style.maxWidth='100vw';
            }
          };

          // open popup (only "Close" button)
          Swal.fire({
            title:'', html: wrap, grow:'fullscreen',
            showConfirmButton:true, confirmButtonText:'‡∏õ‡∏¥‡∏î',
            showDenyButton:false,
            allowOutsideClick:true,
            customClass:{ popup:'qr-fullscreen' },
            didOpen: ()=>{
              renderQR();
              // re-render on viewport resize / orientation change
              const onResize = ()=>{ renderQR(); };
              window.addEventListener('orientationchange', onResize, { passive:true });
              window.visualViewport && window.visualViewport.addEventListener('resize', onResize, { passive:true });
              // cleanup when closed
              Swal.getPopup().addEventListener('transitionend', ()=>{
                if(!Swal.isVisible()){
                  window.removeEventListener('orientationchange', onResize);
                  window.visualViewport && window.visualViewport.removeEventListener('resize', onResize);
                }
              });
            }
          });

          setLoading(false);
        }catch(err){
          console.error(err);
          Swal.fire({icon:'error',title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',text:'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÑ‡∏î‡πâ'});
          $('#submitBtn').innerHTML='‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code'; $('#submitBtn').disabled=false;
        }finally{
          submitting=false;
        }
      }, 350);
    });
  </script>
</body>
</html>
